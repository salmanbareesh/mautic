{#
Variables
- lead
- events
#}
{% extends '@MauticCore/Default/content.html.twig' %}

{% block mauticContent %}lead{% endblock %}

{% set isAnonymous = lead.isAnonymous %}
{% set leadName = lead.isAnonymous ? lead.primaryIdentifier|trans : lead.primaryIdentifier %}
{% set avatar %}
{% if not isAnonymous %}
<span class="pull-left img-wrapper"><img src="{{ leadGetAvatar(lead) }}" alt="{{ leadName|e }}" /></span>
{% endif %}
{% endset %}

{% set flag = fields.core.country is defined and fields.core.country.value is not empty ?
assetGetCountryFlag(fields.core.country.value) : '' %}
{% set groups = fields|keys %}

{% block headerTitle %}
<div class="pull-left mt-5"><span class="span-block">{{ leadName|purify }}</span><span class="span-block small ml-sm">
        {{ lead.secondaryIdentifier|purify }}</span></div>
{% endblock %}

{% block actions %}
{% set canEdit = securityHasEntityAccess(permissions['lead:leads:editown'], permissions['lead:leads:editother'],
lead.permissionUser) %}
{% set buttons = [] %}

{# Send email button #}
{% if fields.core.email is defined %}
{% set buttons = buttons|merge([{
'attr': {
'id': 'sendEmailButton',
'data-toggle': 'ajaxmodal',
'data-target': '#MauticSharedModal',
'data-header': 'mautic.lead.email.send_email.header'|trans({'%email%': fields.core.email.value}),
'href': path('mautic_contact_action', {'objectId': lead.id, 'objectAction': 'email'}),
},
'btnText': 'mautic.lead.email.send_email'|trans,
'iconClass': 'ri-mail-send-line',
'primary': true,
}]) %}
{% endif %}

{# View Contact Frequency button #}
{% if canEdit %}
{% set buttons = buttons|merge([{
'attr': {
'data-toggle': 'ajaxmodal',
'data-target': '#MauticSharedModal',
'data-header': 'mautic.lead.lead.header.contact.frequency'|trans({'%name%': lead.primaryIdentifier|e}),
'href': path('mautic_contact_action', {'objectId': lead.id, 'objectAction': 'contactFrequency'}),
},
'btnText': 'mautic.lead.contact.frequency'|trans,
'iconClass': 'ri-settings-5-line',
}]) %}

{% if pointGroups is not empty %}
{% set buttons = buttons|merge([{
'attr': {
'data-toggle': 'ajaxmodal',
'data-target': '#MauticSharedModal',
'data-header': 'mautic.lead.groups.panel.title'|trans,
'href': path('mautic_contact_action', {'objectId': lead.id, 'objectAction': 'contactGroupPoints'}),
},
'btnText': 'mautic.lead.groups.panel.title'|trans,
'iconClass': 'ri-focus-2-fill',
}]) %}
{% endif %}

{% endif %}

{# View Campaigns List button #}
{% if securityIsGranted('campaign:campaigns:edit') %}
{% set buttons = buttons|merge([{
'attr': {
'data-toggle': 'ajaxmodal',
'data-target': '#MauticSharedModal',
'data-header': 'mautic.lead.lead.header.campaigns'|trans({'%name%': lead.primaryIdentifier|e}),
'data-footer': 'false',
'href': path('mautic_contact_action', {'objectId': lead.id, 'objectAction': 'campaign'}),
},
'btnText': 'mautic.campaign.campaigns'|trans,
'iconClass': 'ri-megaphone-line',
}]) %}
{% endif %}

{# Merge button #}
{% if securityHasEntityAccess(permissions['lead:leads:deleteown'], permissions['lead:leads:deleteother'],
lead.permissionUser) and canEdit %}
{% set buttons = buttons|merge([{
'attr': {
'data-toggle': 'ajaxmodal',
'data-target': '#MauticSharedModal',
'data-header': 'mautic.lead.lead.header.merge'|trans({'%name%': lead.primaryIdentifier|e}),
'href': path('mautic_contact_action', {'objectId': lead.id, 'objectAction': 'merge'}),
},
'btnText': 'mautic.lead.merge'|trans,
'iconClass': 'ri-exchange-2-line',
}]) %}
{% endif %}

{# Download button #}
{% if securityHasEntityAccess(permissions['lead:leads:viewown'], permissions['lead:leads:viewother'],
lead.permissionUser) and enableExportPermission is not empty %}
{% set buttons = buttons|merge([{
'attr': {
'data-toggle': 'download',
'href': path('mautic_contact_export_action', {'contactId': lead.id}),
},
'btnText': 'mautic.core.export'|trans,
'iconClass': 'ri-export-line',
}]) %}
{% endif %}

{{ include('@MauticCore/Helper/page_actions.html.twig', {
'item': lead,
'routeBase': 'contact',
'langVar': 'lead.lead',
'customButtons': buttons,
'templateButtons': {
'edit': canEdit,
'delete': securityHasEntityAccess(
permissions['lead:leads:deleteown'],
permissions['lead:leads:deleteother'],
lead.permissionUser
),
'close': securityHasEntityAccess(
permissions['lead:leads:viewown'],
permissions['lead:leads:viewother'],
lead.permissionUser
),
},
}) }}
{% endblock %}

{% block content %}
<!-- start: box layout -->
<div class="box-layout">
    <!-- left section -->
    <div class="col-md-12 height-auto pa-md">

        <!-- tabs controls -->
        <ul class="nav nav-tabs nav-tabs-line mt-10 mb-lg">
            <li class="active">
                <a href="#overview-tab-content" role="tab" data-toggle="tab">
                    {{ 'mautic.lead.lead.tab.overview'|trans }}
                </a>
            </li>
            <li class="">
                <a href="#history-tab-content" role="tab" data-toggle="tab">
                    {{ 'mautic.lead.lead.tab.history'|trans }}
                </a>
            </li>
            <li class="">
                <a href="#details-tab-content" id="load-lead-map" role="tab" data-toggle="tab">
                    {{ 'mautic.lead.lead.tab.details'|trans }}
                </a>
            </li>
            <li class="">
                <a href="#notes-tab-content" role="tab" data-toggle="tab">
                    {{ 'mautic.lead.lead.tab.notes'|trans }}
                </a>
            </li>
            {{ customContent('tabs', _context) }}
        </ul>
        <!--/ tabs controls -->

        <!-- start: tab-content -->
        <div class="tab-content">
            <!-- #overview-tab-content -->
            <div class="tab-pane fade in active bdr-w-0 gap-sm" id="overview-tab-content">
                <!-- Start first row -->
                <div class="row-no-gutters gap-sm fw-nowrap-lg mb-sm">
                    <div class="col-lg-6 col-xs-12 gap-sm pa-0">
                        <div class="d-flex fd-column fd-row-lg fg-1 gap-sm">
                            <div class="col-lg-3 fd-row fd-column-lg col-xs-12 gap-sm pa-0">
                                <!-- Avatar -->
                                <div class="ar-1-1">{{ avatar }}</div>

                                <!-- Points panel -->
                                <div class="tile ai-center jc-center ar-1-1">
                                    <div class="mt-sm points-panel text-center">
                                        <div class="fs-36"
                                            style="{% if lead.color is not empty %}font-color:{{ lead.color }} !important;{% endif %}">
                                            {{ 'mautic.lead.points.count'|trans({'%count%': lead.points}) }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-9 pa-0">
                                <div class="tile">
                                    <!-- Basic info -->
                                    {% if lead.owner %}
                                    <h6 class="fw-sb">{{ 'mautic.lead.lead.field.owner'|trans }}</h6>
                                    <p class="text-muted">{{ lead.owner.name|purify }}</p>
                                    {% endif %}

                                    <h6 class="fw-sb">
                                        {{ 'mautic.lead.field.address'|trans }}
                                    </h6>
                                    <address class="text-muted">
                                        {% if fields.core.address1 is defined %}{{ fields.core.address1.value|purify
                                        }}<br>{%
                                        endif %}
                                        {% if fields.core.address2 is defined %}{{ fields.core.address2.value|purify
                                        }}<br>{%
                                        endif %}
                                        {{ lead.location|purify }}
                                        {% if fields.core.zipcode is defined %}{{ fields.core.zipcode.value|purify }}{%
                                        endif %}
                                        <br>
                                    </address>

                                    <h6 class="fw-sb">{{ 'mautic.core.type.email'|trans }}</h6>
                                    <p class="text-muted">{{ fields.core.email.value|purify }}</p>

                                    {% if fields.core.phone is defined %}
                                    <h6 class="fw-sb">{{ 'mautic.lead.field.type.tel.home'|trans }}</h6>
                                    <p class="text-muted">{{ fields.core.phone.value|purify }}</p>
                                    {% endif %}

                                    {% if fields.core.mobile is defined %}
                                    <h6 class="fw-sb">{{ 'mautic.lead.field.type.tel.mobile'|trans }}</h6>
                                    <p class="text-muted mb-0">{{ fields.core.mobile.value|purify }}</p>
                                    {% endif %}

                                    <!-- Tags -->
                                    <div class="pa-sm">
                                        {% for tag in lead.tags %}
                                        <div id="tagLabel{{ tag.id }}">
                                            <h5 class="pull-left mt-xs mr-xs">
                                                <span class="label label-success label-tag">
                                                    <a href="{{ path('mautic_tagmanager_action', {'objectAction': 'view', 'objectId': tag.id}) }}"
                                                        data-toggle="ajax" style="color: white;">
                                                        {{ tag.tag|purify }}
                                                    </a>
                                                    <i class="ri-close-line has-click-event"
                                                        onclick="Mautic.removeTagFromLead(this, {{ lead.id }}, {{ tag.id }});"></i>
                                                </span>
                                            </h5>
                                        </div>
                                        {% endfor %}
                                        <div class="clearfix"></div>
                                    </div>

                                    <!-- Group scores -->
                                    {% if lead.groupScores is not empty %}
                                    <div class="panel-heading">
                                        <div class="panel-title">
                                            {{ 'mautic.lead.groups.panel.title'|trans }}
                                        </div>
                                    </div>

                                    <div class="panel-body pt-sm group-points-panel">
                                        {% for groupScore in lead.groupScores %}
                                        <div class="row">
                                            <h6 class="fw-sb col-md-6">
                                                {{ groupScore.group.name }}
                                            </h6>
                                            <p class="text-muted col-md-6">
                                                {{ 'mautic.lead.points.count'|trans({'%count%': groupScore.score}) }}
                                            </p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    <!-- Do Not Contact -->
                                    {% if doNotContact %}
                                    {{ include('@MauticLead/Lead/_dnc_large.html.twig', {'doNotContact': doNotContact})
                                    }}
                                    {% endif %}
                                    {% if doNotContactSms %}
                                    {{ include('@MauticLead/Lead/_dnc_large.html.twig', {'doNotContact':
                                    doNotContactSms})
                                    }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Segments -->
                    <div class="col-lg-3 col-xs-12">
                        <div class="tile">
                            <div class="fw-b mb-sm">{{ 'mautic.lead.lead.lists'|trans }}</div>
                            {% if lists[lead.id] is defined %}
                            {% for key, list in lists[lead.id] %}
                            <h5 class="pull-left mt-xs mr-xs">
                                <span class="label label-success">
                                    <a href="{{ path('mautic_segment_action', {'objectAction': 'view', 'objectId': list.id}) }}"
                                        data-toggle="ajax" style="color: white;">
                                        {{ list.name|purify }}
                                    </a>
                                </span>
                            </h5>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-lg-3 col-xs-12 gap-sm">
                        <!-- Companies -->
                        <div class="panel-companies tile">
                            <div class="fw-b mb-sm">{{ 'mautic.lead.lead.companies'|trans }}</div>
                            {% for key, company in companies %}
                            <h5 class="pull-left mt-xs mr-xs">
                                <span class="label label-success">
                                    <i id="company-{{ company.id }}"
                                        class="ri-check-line {% if 1 == company.is_primary %}primary{% endif %}"
                                        onclick="Mautic.setAsPrimaryCompany({{ company.id }}, {{ lead.id }});"
                                        title="{{ 'mautic.lead.company.set.primary'|trans }}"></i>
                                    <a href="{{ path('mautic_company_action', {'objectAction': 'view', 'objectId': company.id}) }}"
                                        data-toggle="ajax" style="color: white;">
                                        {{ company.companyname|purify }}
                                    </a>
                                </span>
                            </h5>
                            {% endfor %}
                            <div class="clearfix"></div>
                        </div>

                        <!-- Stages -->
                        <div class="tile">
                            <div class="fw-b mb-sm">{{'mautic.stages.menu.index'|trans}}</div>
                            {% if lead.stage %}
                            {{ lead.stage.name|purify }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!--/ End first row -->

                <!-- Start second row -->
                <!-- Channel statistics -->
                <div class="row-no-gutters mb-sm">
                    <div class="col-lg-12" id="lead-stats"
                        data-target-url="{{ path('mautic_contact_stats', {'objectId': lead.id}) }}">
                        <div class="spinner"><i class="fa fa-spin fa-spinner"></i></div>
                    </div>
                </div>
                <!--/ End second row -->

                <!-- Start third row -->
                <div class="row-no-gutters gap-sm fw-nowrap-lg mb-sm">
                    <!-- Engagement chart -->
                    <div class="col-lg-8 col-xs-12">
                        <div class="tile">
                            <div class="panel-body box-layout">
                                <div class="col-xs-8 va-m">
                                    <h5 class="text-white dark-md fw-sb mb-xs">{{
                                        'mautic.lead.field.header.engagements'|trans }}</h5>
                                </div>
                                <div class="col-xs-4 va-t text-right">
                                    <h3 class="text-white dark-sm"><span class="ri-eye-line"></span></h3>
                                </div>
                            </div>
                            {{ include('@MauticCore/Helper/chart.html.twig', {'chartData': engagementData,
                            'chartType': 'line', 'chartHeight': 250}) }}
                        </div>
                    </div>

                    <!-- Upcoming events -->
                    <div class="col-lg-4 col-xs-12">
                        <div class="tile">
                            <div class="fw-b mb-lg">{{ 'mautic.lead.lead.upcoming.events'|trans }}</div>
                            {% if not upcomingEvents %}
                            {{ include('@MauticCore/Helper/no_information.html.twig', {'tip':
                            'mautic.contact.noinformation.upcoming'|trans}) }}
                            {% endif %}
                            <div class="panel-body pt-sm">
                                <ul class="media-list media-list-feed">
                                    {% for event in upcomingEvents %}
                                    {% set metadata = serializerDecode(event.metadata) %}
                                    {% set errors = false %}
                                    {% if metadata.errors is defined and metadata.errors is not empty %}
                                    {% set errors = metadata.errors is iterable ? metadata.errors|join('<br />')
                                    :
                                    metadata.errors %}
                                    {% endif %}
                                    <li class="media">
                                        <div class="media-object pull-left mt-xs">
                                            <span class="figure"></span>
                                        </div>
                                        <div class="media-body">
                                            {{ 'mautic.lead.lead.upcoming.event.triggered.at'|trans({
                                            '%event%': event.event_name,
                                            '%link%': '<a
                                                href="'~path('mautic_campaign_action', {'objectAction': 'view', 'objectId': event.campaign_id})~'"
                                                data-toggle="ajax">'~event.campaign_name~'</a>',
                                            })|purify }}
                                            {% if errors is not empty %}
                                            <i class="ri-alert-line text-danger" data-toggle="tooltip"
                                                title="{{ errors|purify }}"></i>
                                            {% endif %}
                                            <p class="fs-12 dark-sm timeline-campaign-event-date-{{ event.event_id }}">
                                                {{ dateToFull(event.trigger_date, 'utc') }}
                                            </p>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- End upcoming events -->
                </div>
                <!--/ End third row -->
            </div>
            <!--/ #overview-tab-content -->

            <!-- #history-tab-content -->
            <div class="tab-pane fade bdr-w-0" id="history-tab-content">
                <!-- #history-container -->
                <div class="row-no-gutters mb-sm">
                    <div class="col-xs-12">
                        <div class="tile">
                            <div class="row-no-gutters fw-nowrap ai-center mb-lg">
                                <span class="label label-primary mr-sm" id="TimelineCount">{{ events.total }}</span>
                                <div class="fw-b">{{ 'mautic.lead.lead.tab.history'|trans }}</div>
                            </div>
                            {{ include('@MauticLead/Timeline/list.html.twig', {'events': events, 'lead': lead}) }}
                        </div>
                    </div>
                </div>
                <!--/ #history-container -->
                <!-- #auditlog-container -->
                <div class="row-no-gutters">
                    <div class="col-xs-12">
                        <div class="tile">
                            <div class="row-no-gutters fw-nowrap ai-center mb-lg">
                                <span class="label label-primary mr-sm" id="TimelineCount">{{ auditlog.total }}</span>
                                <div class="fw-b">{{ 'mautic.lead.lead.tab.auditlog'|trans }}</div>
                            </div>
                            {{ include('@MauticLead/Auditlog/_list.html.twig', { 'lead': lead, 'events': auditlog, }) }}
                        </div>
                    </div>
                </div>
                <!--/ #auditlog-container -->
            </div>
            <!--/ #history-tab-content -->

            <!-- #details-tab-content -->
            <div class="tab-pane fade bdr-w-0" id="details-tab-content">
                <ul class="accordion mb-lg" id="accordion" role="tablist" aria-multiselectable="true">
                    <!-- Field groups -->
                    {% for group in groups %}
                    <!-- {{ group }} -->
                    {% if fields[group] is not empty %}
                    <li class="panel">
                        <a role="button" id="heading{{ group }}"
                            class="accordion-heading {% if not loop.first %}collapsed{% endif %}" data-toggle="collapse"
                            data-parent="#accordion" href="#collapse{{ group }}"
                            aria-expanded="{% if loop.first %}true{% else %}false{% endif %}"
                            aria-controls="collapse{{ group }}">
                            <i class="ri-arrow-down-s-line accordion-arrow"></i>
                            <span class="accordion-title">
                                {{ ('mautic.lead.field.group.'~group)|trans }}
                                {% if 'social' == group %}
                                <span class="label label-primary ml-xs" id="SocialCount">{{ socialProfiles|length
                                    }}</span>
                                {% endif %}
                            </span>
                        </a>
                        {% endif %}

                        <div id="collapse{{ group }}"
                            class="accordion-wrapper collapse {% if loop.first %}in{% endif %}" role="tabpanel"
                            aria-labelledby="heading{{ group }}">
                            <div class="accordion-content">
                                <div class="row" id="{{ group }}">
                                    <table class="table table-hover mb-0">
                                        <tbody>
                                            {% if 'core' == group %}
                                            {{ include('@MauticCore/Helper/details.html.twig', {'entity': lead}) }}
                                            {% endif %}
                                            {% for field in fields[group] %}
                                            <tr>
                                                <td width="20%"><span class="fw-b textTitle">{{ field.label|purify
                                                        }}</span>
                                                </td>
                                                <td>
                                                    {% if 'core' == group and 'country' == field.alias and flag is not
                                                    empty
                                                    %}
                                                    <img class="mr-sm" src="{{ flag }}" alt=""
                                                        style="max-height: 24px;" />
                                                    <span class="mt-1">{{ field.value|purify }}</span>
                                                    {% else %}
                                                    {% if 'multiselect' == field.type %}
                                                    {% if field.value is iterable %}
                                                    {{ field.value|join(', ') }}
                                                    {% else %}
                                                    {{ field.normalizedValue|purify|replace({'|': ', '}) }}
                                                    {% endif %}
                                                    {% elseif 'url' == field.type %}
                                                    <a href="{{ field.value|purify }}" target="_blank">{{ field.value
                                                        }}</a>
                                                    {% elseif 'html' == field.type %}
                                                    <div style="resize: vertical; overflow: auto">{{ field.value|e }}
                                                    </div>
                                                    {% elseif 'datetime' == field.type %}
                                                    {{ dateToFullConcat(field.value, 'UTC') }}
                                                    {% else %}
                                                    {{ field.normalizedValue|purify }}
                                                    {% endif %}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                {% if 'social' == group %}
                                <!-- #social-container -->
                                {% if not isAnonymous and socialProfiles is not empty %}
                                <div class="tile" id="social-container">
                                    {{ include('@MauticLead/Social/index.html.twig', {
                                    'lead': lead,
                                    'socialProfiles': socialProfiles,
                                    'socialProfileUrls': socialProfileUrls,
                                    }) }}
                                </div>
                                {% endif %}
                                <!--/ #social-container -->
                                {% endif %}

                                {% endfor %}
                            </div>
                        </div>
                    </li>

                    <!-- Devices -->
                    <li class="panel">
                        <a role="button" id="headingdevices" class="accordion-heading collapsed" data-toggle="collapse"
                            data-parent="#accordion" href="#collapsedevices" aria-expanded="false"
                            aria-controls="collapsedevices">
                            <i class="ri-arrow-down-s-line accordion-arrow"></i>
                            <span class="accordion-title">{{'mautic.lead.devices'|trans}}</span>
                        </a>

                        <div id="collapsedevices" class="collapse accordion-wrapper" role="tabpanel"
                            aria-labelledby="headingdevices">
                            <div class="accordion-content">
                                {{ include('@MauticLead/Lead/_devices.html.twig', {'devices': devices}) }}
                            </div>
                        </div>
                    </li>

                    <!-- Integrations -->
                    <li class="panel">
                        <a role="button" id="headingintegrations" class="accordion-heading collapsed"
                            data-toggle="collapse" data-parent="#accordion" href="#collapseintegrations"
                            aria-expanded="false" aria-controls="collapseintegrations">
                            <i class="ri-arrow-down-s-line accordion-arrow"></i>
                            <span class="accordion-title">
                                {{'mautic.lead.lead.tab.integration'|trans}}
                                <span class="label label-primary ml-xs" id="IntegrationCount">{{ integrations|length
                                    }}</span>
                            </span>
                        </a>

                        <div id="collapseintegrations" class="collapse accordion-wrapper" role="tabpanel"
                            aria-labelledby="headingintegrations">
                            <div class="accordion-content">
                                {{ include('@MauticLead/Integration/index.html.twig', { 'lead': lead, 'integrations':
                                integrations, }) }}
                            </div>
                        </div>
                    </li>
                </ul>

                <!-- Places -->
                <div class="tile" id="place-container">
                    {% if not places %}
                    {{ include('@MauticCore/Helper/no_information.html.twig', {
                    'tip': 'mautic.contact.noinformation.places'
                    }) }}
                    {% endif %}
                    {{ include('@MauticLead/Lead/_map.html.twig', {'places': places}) }}
                </div>

                <!-- Custom content -->
                <div class="tile">
                    {{ customContent('tabs.content', _context) }}
                </div>
                <!-- end: custom content -->

            </div>
            <!--/ #details-tab-content -->

            <!-- #notes-tab-content -->
            <div class="tab-pane fade bdr-w-0" id="notes-tab-content">
                {{ render(controller('Mautic\\LeadBundle\\Controller\\NoteController::indexAction', {'leadId':
                lead.id, 'ignoreAjax': 1})) }}
            </div>
            <!--/ #notes-tab-content -->
        </div>
        <!--/ end: tab-content -->
    </div>
    <!--/ left section -->
</div>
<!--/ end: box layout -->
{% endblock %}